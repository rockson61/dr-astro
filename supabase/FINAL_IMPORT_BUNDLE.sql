-- MASTER SCHEMA: DENTALREACH ASTRO
-- Consolidates all legacy features + new requirements

-- Enable necessary extensions
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pg_trgm";
CREATE EXTENSION IF NOT EXISTS "pgcrypto";

-- CLEANUP (Reset for Import)
DROP TRIGGER IF EXISTS update_profiles_updated_at ON public.profiles;
DROP TRIGGER IF EXISTS update_articles_updated_at ON public.articles;
DROP TABLE IF EXISTS public.posts CASCADE;
DROP TABLE IF EXISTS public.threads CASCADE;
DROP TABLE IF EXISTS public.seo_settings CASCADE;
DROP TABLE IF EXISTS public.showcase_products CASCADE;
DROP TABLE IF EXISTS public.awards CASCADE;
DROP TABLE IF EXISTS public.listings CASCADE;
DROP TABLE IF EXISTS public.podcasts CASCADE;
DROP TABLE IF EXISTS public.jobs CASCADE;
DROP TABLE IF EXISTS public.events CASCADE;
DROP TABLE IF EXISTS public.articles CASCADE;
DROP TABLE IF EXISTS public.categories CASCADE;
DROP TABLE IF EXISTS public.profiles CASCADE;

DROP TYPE IF EXISTS user_role CASCADE;
DROP TYPE IF EXISTS article_status CASCADE;
DROP TYPE IF EXISTS event_type CASCADE;
DROP TYPE IF EXISTS job_type_enum CASCADE;

-- Enums
CREATE TYPE user_role AS ENUM ('super_admin', 'admin', 'editor', 'author', 'dentist', 'student', 'business', 'member', 'professional', 'team', 'company');
CREATE TYPE article_status AS ENUM ('draft', 'under_review', 'published', 'archived');
CREATE TYPE event_type AS ENUM ('conference', 'webinar', 'workshop', 'seminar', 'networking', 'exhibition');
CREATE TYPE job_type_enum AS ENUM ('full_time', 'part_time', 'contract', 'locum', 'internship');

-- 1. PROFILES
CREATE TABLE public.profiles (
  id UUID REFERENCES auth.users(id) PRIMARY KEY,
  email TEXT,
  username TEXT UNIQUE, -- Made nullable for legacy compat
  full_name TEXT,
  first_name TEXT,
  last_name TEXT,
  role user_role DEFAULT 'dentist',
  is_verified BOOLEAN DEFAULT false,
  subscription_tier TEXT DEFAULT 'free',
  avatar_url TEXT,
  bio TEXT,
  specialty TEXT,
  clinic_name TEXT,
  location TEXT,
  website_url TEXT,
  years_of_experience INTEGER,
  slug TEXT UNIQUE,
  wp_author_id INTEGER,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Public profiles" ON public.profiles FOR SELECT USING (true);

-- 2. CATEGORIES
CREATE TABLE public.categories (
  id SERIAL PRIMARY KEY,
  name TEXT NOT NULL,
  slug TEXT UNIQUE NOT NULL,
  description TEXT,
  parent_id INTEGER REFERENCES public.categories(id),
  created_at TIMESTAMPTZ DEFAULT NOW()
);
ALTER TABLE public.categories ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Public categories" ON public.categories FOR SELECT USING (true);

-- 3. ARTICLES
CREATE TABLE public.articles (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  slug TEXT UNIQUE NOT NULL,
  title TEXT NOT NULL,
  excerpt TEXT,
  content TEXT, -- Mixed HTML/JSON support
  status article_status DEFAULT 'draft',
  category TEXT, -- Legacy Text Support
  category_id INTEGER REFERENCES public.categories(id),
  author_id UUID REFERENCES public.profiles(id),
  is_scholarly BOOLEAN DEFAULT false,
  is_approved BOOLEAN DEFAULT true,
  is_featured BOOLEAN DEFAULT false,
  doi TEXT,
  citation_style TEXT DEFAULT 'APA',
  "references" JSONB DEFAULT '[]'::JSONB,
  image_url TEXT,
  gallery TEXT[],
  meta_title TEXT,
  meta_description TEXT,
  views_count INTEGER DEFAULT 0,
  likes_count INTEGER DEFAULT 0,
  published_at TIMESTAMPTZ,
  reading_time INTEGER,
  tags TEXT[],
  keywords TEXT[],
  abstract TEXT,
  methodology TEXT,
  conclusions TEXT,
  file_url TEXT,
  seo_keywords TEXT[],
  -- WordPress Migration Columns
  wp_post_id INTEGER,
  wp_guid TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
ALTER TABLE public.articles ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Public articles" ON public.articles FOR SELECT USING (true);

-- 4. EVENTS
CREATE TABLE public.events (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  title TEXT NOT NULL,
  slug TEXT UNIQUE NOT NULL,
  description TEXT,
  type event_type DEFAULT 'webinar',
  start_date TIMESTAMPTZ, -- Make nullable if legacy data is partial
  end_date TIMESTAMPTZ,
  date TIMESTAMPTZ, -- Legacy compat
  time TEXT,
  is_virtual BOOLEAN DEFAULT false,
  location TEXT,
  location_name TEXT, -- Alias
  registration_url TEXT,
  organizer_id UUID REFERENCES public.profiles(id),
  image_url TEXT,
  status TEXT DEFAULT 'upcoming',
  website TEXT,
  country TEXT,
  country_code TEXT,
  event_format TEXT,
  event_category TEXT,
  max_attendees INTEGER,
  price NUMERIC,
  registration_deadline TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
ALTER TABLE public.events ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Public events" ON public.events FOR SELECT USING (true);

-- 5. JOB POSTINGS (Legacy Name)
CREATE TABLE public.jobs ( -- Internal name 'jobs', legacy was 'job_postings'
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  employer_id UUID REFERENCES public.profiles(id),
  posted_by UUID REFERENCES public.profiles(id), -- Legacy alias for employer_id
  title TEXT NOT NULL,
  slug TEXT UNIQUE,
  company_name TEXT NOT NULL,
  location TEXT NOT NULL,
  type TEXT, -- Simplifies ENUM issues
  salary_range TEXT,
  description JSONB, -- Or Text
  requirements TEXT[],
  benefits TEXT[],
  experience_level TEXT,
  apply_url TEXT,
  logo_url TEXT,
  is_active BOOLEAN DEFAULT true,
  expires_at TIMESTAMPTZ,
  application_deadline TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
ALTER TABLE public.jobs ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Public jobs" ON public.jobs FOR SELECT USING (true);

-- 6. PODCASTS
CREATE TABLE public.podcasts (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    title TEXT NOT NULL,
    description TEXT,
    host_name TEXT,
    guest_names TEXT[],
    category TEXT,
    duration_minutes INTEGER,
    episode_number INTEGER,
    season_number INTEGER,
    spotify_url TEXT,
    image_url TEXT,
    is_approved BOOLEAN DEFAULT true,
    is_featured BOOLEAN DEFAULT false,
    views_count INTEGER DEFAULT 0,
    likes_count INTEGER DEFAULT 0,
    user_id UUID REFERENCES public.profiles(id),
    slug TEXT UNIQUE,
    tags TEXT[],
    transcript TEXT,
    key_topics TEXT[],
    meta_title TEXT,
    meta_description TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
ALTER TABLE public.podcasts ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Public podcasts" ON public.podcasts FOR SELECT USING (true);

-- 7. DIRECTORY / LISTINGS
CREATE TABLE public.listings (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  owner_id UUID REFERENCES public.profiles(id),
  business_name TEXT NOT NULL,
  slug TEXT UNIQUE NOT NULL,
  description TEXT,
  address_json JSONB,
  contact_email TEXT,
  contact_phone TEXT,
  website TEXT,
  type TEXT,
  amenities TEXT[],
  opening_hours JSONB,
  rating_avg NUMERIC(3,2) DEFAULT 0,
  is_verified BOOLEAN DEFAULT false,
  gallery TEXT[],
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
ALTER TABLE public.listings ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Public listings" ON public.listings FOR SELECT USING (true);

-- 8. AWARDS
CREATE TABLE public.awards (
    id SERIAL PRIMARY KEY,
    title TEXT NOT NULL,
    slug TEXT UNIQUE NOT NULL,
    year INTEGER NOT NULL,
    status TEXT DEFAULT 'nominations_open',
    hero_image TEXT,
    description TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);
ALTER TABLE public.awards ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Public awards" ON public.awards FOR SELECT USING (true);

-- 9. SHOWCASE PRODUCTS
CREATE TABLE public.showcase_products (
  id SERIAL PRIMARY KEY,
  name TEXT NOT NULL,
  endorsement TEXT,
  link TEXT,
  image TEXT,
  size TEXT DEFAULT 'standard',
  gradient TEXT DEFAULT 'from-gray-900/50 to-transparent',
  description TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
ALTER TABLE public.showcase_products ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Public products" ON public.showcase_products FOR SELECT USING (true);

-- 10. SEO SETTINGS
CREATE TABLE public.seo_settings (
  id SERIAL PRIMARY KEY,
  page_slug VARCHAR(255) UNIQUE NOT NULL,
  meta_title VARCHAR(255),
  meta_description TEXT,
  meta_keywords TEXT[], 
  og_type VARCHAR(50) DEFAULT 'website',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
ALTER TABLE public.seo_settings ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Public seo" ON public.seo_settings FOR SELECT USING (true);

-- 11. FORUM (Threads/Posts)
CREATE TABLE public.threads (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  title TEXT NOT NULL,
  slug TEXT UNIQUE, 
  author_id UUID REFERENCES public.profiles(id),
  category TEXT NOT NULL,
  content JSONB, 
  view_count INTEGER DEFAULT 0,
  is_pinned BOOLEAN DEFAULT false,
  is_locked BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
ALTER TABLE public.threads ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Public threads" ON public.threads FOR SELECT USING (true);

CREATE TABLE public.posts (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  thread_id UUID REFERENCES public.threads(id) ON DELETE CASCADE NOT NULL,
  author_id UUID REFERENCES public.profiles(id),
  content JSONB NOT NULL,
  parent_id UUID REFERENCES public.posts(id), 
  is_deleted BOOLEAN DEFAULT false,
  is_accepted_answer BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
ALTER TABLE public.posts ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Public posts" ON public.posts FOR SELECT USING (true);

-- TRIGGERS
CREATE OR REPLACE FUNCTION update_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_profiles_updated_at BEFORE UPDATE ON public.profiles FOR EACH ROW EXECUTE FUNCTION update_updated_at();
CREATE TRIGGER update_articles_updated_at BEFORE UPDATE ON public.articles FOR EACH ROW EXECUTE FUNCTION update_updated_at();
-- SEED DATA FROM LEGACY MIGRATION
-- Sanitized and compatible with new schema

CREATE EXTENSION IF NOT EXISTS "pgcrypto";

-- 7.0 CREATE AUTH USERS (REQUIRED FOR PROFILES FK)
INSERT INTO auth.users (id, email, encrypted_password, email_confirmed_at, raw_app_meta_data, raw_user_meta_data, aud, role)
VALUES 
  ('1e04ac95-b236-4d76-9d10-36eddf9e7e72', 'sarah.johnson@example.com', crypt('password123', gen_salt('bf')), NOW(), '{"provider":"email","providers":["email"]}', '{"full_name":"Dr. Sarah Johnson"}', 'authenticated', 'authenticated'),
  ('22222222-2222-2222-2222-222222222222', 'michael.chen@example.com', crypt('password123', gen_salt('bf')), NOW(), '{"provider":"email","providers":["email"]}', '{"full_name":"Dr. Michael Chen"}', 'authenticated', 'authenticated'),
  ('33333333-3333-3333-3333-333333333333', 'emily.davis@example.com', crypt('password123', gen_salt('bf')), NOW(), '{"provider":"email","providers":["email"]}', '{"full_name":"Dr. Emily Davis"}', 'authenticated', 'authenticated'),
  ('44444444-4444-4444-4444-444444444444', 'james.wilson@example.com', crypt('password123', gen_salt('bf')), NOW(), '{"provider":"email","providers":["email"]}', '{"full_name":"Dr. James Wilson"}', 'authenticated', 'authenticated'),
  ('55555555-5555-5555-5555-555555555555', 'robert.smith@example.com', crypt('password123', gen_salt('bf')), NOW(), '{"provider":"email","providers":["email"]}', '{"full_name":"Dr. Robert Smith"}', 'authenticated', 'authenticated')
ON CONFLICT (id) DO NOTHING;

-- 7.1 Profiles (5 DENTISTS)
INSERT INTO public.profiles (id, full_name, first_name, last_name, slug, is_verified, avatar_url, role, email, bio, specialty, clinic_name, location, years_of_experience)
VALUES 
  ('1e04ac95-b236-4d76-9d10-36eddf9e7e72', 'Dr. Sarah Johnson', 'Sarah', 'Johnson', 'dr-sarah-johnson', true, 'https://images.unsplash.com/photo-1559839734-2b71ea197ec2?auto=format&fit=crop&q=80', 'dentist', 'sarah.johnson@example.com', 'Pioneer in Digital Dentistry with 15+ years experience.', 'Prosthodontist', 'Johnson Dental Arts', 'New York, USA', 15),
  ('22222222-2222-2222-2222-222222222222', 'Dr. Michael Chen', 'Michael', 'Chen', 'dr-michael-chen', true, 'https://images.unsplash.com/photo-1612349317150-e413f6a5b16d?auto=format&fit=crop&q=80', 'dentist', 'michael.chen@example.com', 'Specializing in minimally invasive cosmetic procedures.', 'Cosmetic Dentist', 'Chen Smiles', 'San Francisco, USA', 10),
  ('33333333-3333-3333-3333-333333333333', 'Dr. Emily Davis', 'Emily', 'Davis', 'dr-emily-davis', false, 'https://images.unsplash.com/photo-1594824476967-48c8b964273f?auto=format&fit=crop&q=80', 'dentist', 'emily.davis@example.com', 'Passionate about pediatric dental health and education.', 'Pediatric Dentist', 'Tiny Teeth Clinic', 'London, UK', 8),
  ('44444444-4444-4444-4444-444444444444', 'Dr. James Wilson', 'James', 'Wilson', 'dr-james-wilson', true, 'https://images.unsplash.com/photo-1500648767791-00dcc994a43e?auto=format&fit=crop&q=80', 'dentist', 'james.wilson@example.com', 'Integrating technology into daily dental practice.', 'General Dentist', 'Wilson Family Dental', 'Berlin, Germany', 12),
  ('55555555-5555-5555-5555-555555555555', 'Dr. Robert Smith', 'Robert', 'Smith', 'dr-robert-smith', true, 'https://images.unsplash.com/photo-1537368910025-700350fe46c7?auto=format&fit=crop&q=80', 'dentist', 'robert.smith@example.com', 'Expert in Oral Surgery and Implantology.', 'Oral Surgeon', 'Smith Implants', 'Sydney, Australia', 20)
ON CONFLICT (id) DO UPDATE 
SET full_name = EXCLUDED.full_name, first_name = EXCLUDED.first_name, last_name = EXCLUDED.last_name, slug = EXCLUDED.slug, avatar_url = EXCLUDED.avatar_url, role = EXCLUDED.role, email = EXCLUDED.email;

-- 7.2 Articles
INSERT INTO public.articles (
  title, slug, excerpt, content, category, author_id, is_approved, image_url, views_count, reading_time, tags, doi, "references", created_at
) VALUES
  ('The Future of Digital Dentistry', 'future-of-digital-dentistry', 'AI and 3D printing are revolutionizing dental workflows.', '<p>Deep dive into AI...</p>', 'Editorial', '1e04ac95-b236-4d76-9d10-36eddf9e7e72', true, 'https://images.unsplash.com/photo-1579684385127-1ef15d508118', 1250, 5, ARRAY['AI', 'Technology'], '10.1038/s41415-023-0001', '[{"title": "AI in Dentistry", "year": "2025"}]'::jsonb, NOW()),
  ('Global Dental Market Trends 2026', 'global-dental-market-trends-2026', 'Market analysis predicts 7% growth.', '<p>Market content...</p>', 'News', '22222222-2222-2222-2222-222222222222', true, 'https://images.unsplash.com/photo-1606811841689-23dfddce3e95', 980, 4, ARRAY['Market', 'Business'], '10.1038/s41415-023-0002', '[{"title": "Global Market Report", "year": "2025"}]'::jsonb, NOW() - INTERVAL '1 day'),
  ('New Minimally Invasive Techniques', 'new-minimally-invasive-techniques', 'Preserving tooth structure.', '<p>Clinical content...</p>', 'Editorial', '33333333-3333-3333-3333-333333333333', true, 'https://images.unsplash.com/photo-1609840114035-1c29046a8af3', 1500, 7, ARRAY['Clinical', 'Restorative'], '10.1038/s41415-023-0003', '[{"title": "Minimally Invasive dentistry", "year": "2024"}]'::jsonb, NOW() - INTERVAL '3 days'),
  ('Evaluating Intraoral Scanners', 'evaluating-intraoral-scanners', 'A comparative study of top scanners.', '<p>Detailed comparisons...</p>', 'Clinical', '44444444-4444-4444-4444-444444444444', true, 'https://images.unsplash.com/photo-1516321497487-e288fb19713f', 800, 3, ARRAY['Scanners', 'Comparison'], NULL, '[]'::jsonb, NOW() - INTERVAL '5 days'),
  ('Complex Implant Cases', 'complex-implant-cases', 'Managing poor bone quality.', '<p>Case report...</p>', 'Clinical', '55555555-5555-5555-5555-555555555555', true, 'https://images.unsplash.com/photo-1563986768609-322da13575f3', 2100, 6, ARRAY['Implants', 'Surgery'], NULL, '[]'::jsonb, NOW() - INTERVAL '1 week');

-- 7.3 Events
INSERT INTO public.events (
  title, slug, description, start_date, end_date, location, country, image_url, type, is_virtual, organizer_id, status, website
) VALUES
  ('Global Dental Summit 2026', 'global-dental-summit-2026', 'Overview of modern techniques.', (NOW() + INTERVAL '30 days'), (NOW() + INTERVAL '32 days'), 'New York, NY', 'United States', 'https://images.unsplash.com/photo-1588195538326-c5f1f237a15b', 'conference', false, '1e04ac95-b236-4d76-9d10-36eddf9e7e72', 'upcoming', 'https://summit.example.com'),
  ('Advanced Implantology Workshop', 'advanced-implantology-workshop', 'Hands-on training.', (NOW() + INTERVAL '45 days'), (NOW() + INTERVAL '45 days'), 'London, UK', 'United Kingdom', 'https://images.unsplash.com/photo-1576091160399-112ba8d25d1d', 'workshop', false, '22222222-2222-2222-2222-222222222222', 'upcoming', 'https://workshop.example.com'),
  ('Pediatric Dentistry Webinar', 'pediatric-dentistry-webinar', 'Managing anxious patients.', (NOW() + INTERVAL '10 days'), (NOW() + INTERVAL '10 days'), 'Online', 'Global', 'https://images.unsplash.com/photo-1596495577886-d920f1fb7238', 'webinar', true, '33333333-3333-3333-3333-333333333333', 'upcoming', 'https://webinar.example.com');

-- 7.4 Jobs
INSERT INTO public.jobs (title, slug, company_name, location, type, description, employer_id, is_active, salary_range)
VALUES
  ('Associate Dentist', 'associate-dentist-chicago', 'Johnson Dental Arts', 'Chicago, IL', 'full_time', '{"text": "Join our growing family practice."}', '1e04ac95-b236-4d76-9d10-36eddf9e7e72', true, '$150k - $220k'),
  ('Dental Hygienist', 'dental-hygienist-boston', 'Chen Smiles', 'Boston, MA', 'part_time', '{"text": "Seeking energetic hygienist."}', '22222222-2222-2222-2222-222222222222', true, '$45 - $60 / hr'),
  ('Orthodontist', 'orthodontist-los-angeles', 'Tiny Teeth Clinic', 'Los Angeles, CA', 'full_time', '{"text": "Partner track available."}', '33333333-3333-3333-3333-333333333333', true, '$250k - $400k');

-- 7.5 Podcasts
INSERT INTO public.podcasts (title, slug, host_name, category, duration_minutes, episode_number, spotify_url, image_url, user_id, is_approved, tags)
VALUES
  ('Bits & Bytes of Dentistry', 'bits-and-bytes-of-dentistry', 'Dr. Sarah Johnson', 'Dental Technology', 45, 12, 'https://spotify.com', 'https://images.unsplash.com/photo-1590602847861-f357a9332bbc', '1e04ac95-b236-4d76-9d10-36eddf9e7e72', true, ARRAY['Tech', 'Innovation']),
  ('The Dental Business', 'the-dental-business', 'Dr. Michael Chen', 'Practice Management', 30, 8, 'https://spotify.com', 'https://images.unsplash.com/photo-1478737270239-2f52b7126c71', '22222222-2222-2222-2222-222222222222', true, ARRAY['Business', 'Finance']);

-- 7.6 Showcase Products
INSERT INTO public.showcase_products (name, endorsement, link, image, size, gradient, description) VALUES 
('3Shape TRIOS 5', 'Best-in-class intraoral scanner.', 'https://www.3shape.com', 'https://images.unsplash.com/photo-1629909613654-28e377c37b09', 'large', 'from-purple-900/80 to-transparent', 'The TRIOS 5 sets a new standard.'),
('Formlabs Form 3B+', 'Reliable 3D printing.', 'https://dental.formlabs.com', 'https://images.unsplash.com/photo-1631248055158-edec7a3c072b', 'tall', 'from-blue-900/80 to-transparent', 'Advanced desktop 3D printer.'),
('Philips Zoom WhiteSpeed', 'Top-rated whitening.', 'https://www.philips.ca', 'https://images.unsplash.com/photo-1598256989800-fe5f95da9787', 'medium', 'from-blue-600/80 to-transparent', 'Clinically proven results.');
-- CREATE ADMIN USER: rockson68@hotmail.com
-- Password: password123

CREATE EXTENSION IF NOT EXISTS "pgcrypto";

DO $$
DECLARE
  v_user_id UUID := '68686868-6868-6868-6868-686868686868';
  v_email TEXT := 'rockson68@hotmail.com';
BEGIN
  -- 1. Create Identity in auth.users
  -- Check if user exists first to verify we handle updates or specific ID
  IF NOT EXISTS (SELECT 1 FROM auth.users WHERE email = v_email) THEN
      INSERT INTO auth.users (
        id, instance_id, aud, role, email, encrypted_password, 
        email_confirmed_at, raw_app_meta_data, raw_user_meta_data, created_at, updated_at
      ) VALUES (
        v_user_id, 
        '00000000-0000-0000-0000-000000000000', 
        'authenticated', 
        'authenticated', 
        v_email, 
        crypt('password123', gen_salt('bf')), 
        NOW(), 
        '{"provider": "email", "providers": ["email"]}', 
        '{"full_name": "Rockson Admin"}', 
        NOW(), 
        NOW()
      );
  END IF;

  -- 2. Create/Update Profile to Super Admin
  INSERT INTO public.profiles (id, email, role, full_name, slug, is_verified)
  VALUES (
    v_user_id, 
    v_email, 
    'super_admin', 
    'Rockson Admin', 
    'rockson-admin',
    true
  ) ON CONFLICT (id) DO UPDATE SET role = 'super_admin', is_verified = true;

END $$;
