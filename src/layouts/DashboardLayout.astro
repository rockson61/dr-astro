---
import "../styles/global.css";
import { createSupabaseServerClient } from "../lib/supabase";
import NotificationBell from "../components/ui/NotificationBell";

interface Props {
    title: string;
}

const { title } = Astro.props;
const currentPath = Astro.url.pathname;
const supabase = createSupabaseServerClient(Astro);

// 1. Get User
const {
    data: { user },
} = await supabase.auth.getUser();

if (!user) {
    return Astro.redirect("/login");
}

// 2. Get Profile & Role
const { data: profile } = await supabase
    .from("profiles")
    .select("role, full_name, avatar_url, specialty, is_verified")
    .eq("id", user.id)
    .single();

const role = profile?.role || "dentist";
const isSuperAdmin = role === "super_admin";
const isAdmin = role === "admin" || isSuperAdmin;
const isEditor = role === "editor" || isAdmin;
const isModerator = role === "moderator" || isAdmin;

// 3. Define Navigation
const allLinks = [
    {
        section: "Overview",
        roles: ["all"],
        items: [{ label: "Dashboard", href: "/dashboard", icon: "üìä" }],
    },
    {
        section: "Admin Panel",
        roles: ["super_admin", "admin"],
        items: [
            { label: "Overview", href: "/dashboard/admin", icon: "üß†" },
            { label: "Users", href: "/dashboard/admin/users", icon: "üë•" },
            { label: "System Logs", href: "/dashboard/admin/logs", icon: "üìú" },
        ],
    },
    {
        section: "Editorial Desk",
        roles: ["super_admin", "admin", "editor"],
        items: [
            { label: "All Articles", href: "/dashboard/editor", icon: "üì∞" },
            { label: "Issues", href: "/dashboard/issues", icon: "üìÖ" },
        ],
    },
    {
        section: "Moderation",
        roles: ["super_admin", "admin", "moderator"],
        items: [
            { label: "Comments", href: "/dashboard/moderator", icon: "üí¨" },
            {
                label: "Reports",
                href: "/dashboard/moderator/reports",
                icon: "üö©",
            },
        ],
    },
    {
        section: "My Content",
        roles: ["all"], // Everyone can create content
        items: [
            {
                label: "My Articles",
                href: "/dashboard/my-articles",
                icon: "üìù",
            },
            {
                label: "My Listings",
                href: "/dashboard/my-listings",
                icon: "üè¢",
            },
            { label: "My Jobs", href: "/dashboard/my-jobs", icon: "üíº" },
            { label: "My Events", href: "/dashboard/my-events", icon: "üìÖ" },
            { label: "My Awards", href: "/dashboard/my-awards", icon: "üèÜ" },
        ],
    },
    {
        section: "Marketplace",
        roles: ["all"],
        items: [
            {
                label: "My Products",
                href: "/dashboard/my-products",
                icon: "üì¶",
            },
            { label: "Inquiries", href: "/dashboard/inquiries", icon: "üì©" },
        ],
    },
    {
        section: "Create",
        roles: ["all"],
        items: [
            {
                label: "New Article",
                href: "/dashboard/articles/new",
                icon: "‚úçÔ∏è",
            },
            {
                label: "New Listing",
                href: "/dashboard/listings/new",
                icon: "‚ûï",
            },
            {
                label: "New Job",
                href: "/dashboard/jobs/new",
                icon: "briefcase",
            },
            {
                label: "New Event",
                href: "/dashboard/events/new",
                icon: "calendar-plus",
            },
        ],
    },
    {
        section: "Account",
        roles: ["all"],
        items: [{ label: "Settings", href: "/dashboard/settings", icon: "‚öôÔ∏è" }],
    },
];

// Filter Links
const sidebarLinks = allLinks
    .map((section) => ({
        ...section,
        visible:
            section.roles.includes("all") ||
            section.roles.some((r) => r === role) ||
            (isSuperAdmin && section.roles.includes("super_admin")),
    }))
    .filter(
        (s) =>
            s.visible ||
            (s.roles.includes("admin") && isAdmin) ||
            (s.roles.includes("editor") && isEditor) ||
            (s.roles.includes("moderator") && isModerator),
    );

// Simplified logic for template rendering because 'visible' logic above is a bit complex to debug inline
// Let's use a cleaner filter:
const visibleSections = allLinks.filter((section) => {
    if (section.roles.includes("all")) return true;
    if (section.roles.includes(role)) return true;
    if (isAdmin && section.roles.includes("admin")) return true;
    if (isSuperAdmin && section.roles.includes("super_admin")) return true;
    if (isEditor && section.roles.includes("editor")) return true;
    if (isModerator && section.roles.includes("moderator")) return true;
    return false;
});
---

<!doctype html>
<html lang="en" class="scroll-smooth">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width" />
        <link rel="icon" type="image/png" href="/images/logo-mini.png" />
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Paytone+One&display=swap"
            rel="stylesheet"
        />
        <title>{title} | DR Dashboard</title>
    </head>
    <body
        class="bg-gray-50 flex h-screen overflow-hidden text-primary-900 font-body"
    >
        <!-- Sidebar -->
        <aside
            class="w-72 bg-primary-900 flex-shrink-0 flex flex-col hidden md:flex relative overflow-hidden transition-all duration-300"
        >
            <div
                class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-5 pointer-events-none"
            >
            </div>

            <!-- Logo -->
            <div
                class="h-24 flex items-center px-8 border-b border-white/10 relative z-10"
            >
                <a href="/" class="flex items-center gap-3 group">
                    <div
                        class="w-10 h-10 bg-primary-600 rounded-xl flex items-center justify-center group-hover:scale-110 transition-transform shadow-lg shadow-primary-600/20"
                    >
                        <span class="text-white font-heading text-xl">D</span>
                    </div>
                    <div>
                        <span
                            class="font-heading text-xl uppercase text-white tracking-wide block leading-none"
                            >Dental</span
                        >
                        <span
                            class="font-heading text-sm uppercase text-primary-300 tracking-widest block leading-none"
                            >Reach</span
                        >
                    </div>
                </a>
            </div>

            <!-- Navigation -->
            <nav
                class="flex-grow p-6 space-y-8 overflow-y-auto relative z-10 custom-scrollbar"
            >
                {
                    visibleSections.map((section) => (
                        <div>
                            <div class="text-xs font-bold text-primary-300 uppercase tracking-widest mb-4 px-4 font-heading opacity-80 flex items-center justify-between">
                                {section.section}
                                {section.roles.includes("super_admin") && (
                                    <span class="text-[10px] bg-red-500 text-white px-1.5 py-0.5 rounded">
                                        ADMIN
                                    </span>
                                )}
                            </div>
                            <div class="space-y-2">
                                {section.items.map((item) => (
                                    <a
                                        href={item.href}
                                        class={`flex items-center gap-3 px-4 py-3 rounded-2xl font-bold transition-all duration-300 ${
                                            currentPath === item.href
                                                ? "bg-primary-600 text-white shadow-lg shadow-primary-600/30 translate-x-2"
                                                : "text-white/60 hover:bg-white/10 hover:text-white hover:translate-x-1"
                                        }`}
                                    >
                                        <span class="text-lg opacity-80 min-w-[24px] text-center">
                                            {item.icon}
                                        </span>
                                        {item.label}
                                    </a>
                                ))}
                            </div>
                        </div>
                    ))
                }
            </nav>

            <!-- Footer -->
            <div
                class="p-6 border-t border-white/10 relative z-10 bg-primary-900/50 backdrop-blur-sm"
            >
                <a
                    href="/"
                    class="flex items-center gap-2 text-white/40 hover:text-white transition-colors text-sm mb-4 font-bold uppercase tracking-wide"
                >
                    ‚Üê Back to Site
                </a>
                <button
                    id="logout-btn"
                    class="flex items-center gap-2 text-red-400 hover:text-red-300 text-sm font-bold bg-white/5 px-4 py-3 rounded-xl w-full justify-center hover:bg-white/10 transition-all"
                >
                    <svg
                        class="w-4 h-4"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                        ><path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
                        ></path></svg
                    >
                    Sign Out
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-grow flex flex-col h-full overflow-hidden relative">
            <!-- Header -->
            <header
                class="h-24 bg-white/80 backdrop-blur-md border-b border-gray-100 flex items-center justify-between px-8 shadow-sm z-20"
            >
                <div class="flex items-center gap-4">
                    <button
                        class="md:hidden w-10 h-10 bg-gray-100 rounded-xl flex items-center justify-center text-primary-900"
                    >
                        <svg
                            class="w-6 h-6"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                            ><path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M4 6h16M4 12h16M4 18h16"></path></svg
                        >
                    </button>
                    <h1
                        class="text-3xl font-heading uppercase text-primary-900 tracking-tight"
                    >
                        {title}
                    </h1>
                </div>
                <div class="flex items-center gap-6">
                    <!-- Notifications -->
                    <div class="hidden md:block">
                        <NotificationBell client:load />
                    </div>

                    <!-- Profile -->
                    <div
                        class="flex items-center gap-3 pl-6 border-l border-gray-100"
                    >
                        <div class="text-right hidden sm:block">
                            <div class="font-bold text-primary-900 text-sm">
                                {
                                    profile?.full_name ||
                                        user.email?.split("@")[0]
                                }
                            </div>
                            <div
                                class="text-[10px] text-primary-600 font-bold uppercase tracking-wider flex items-center justify-end gap-1"
                            >
                                {
                                    isSuperAdmin
                                        ? "üî¥ SUPER ADMIN"
                                        : role.replace("_", " ")
                                }
                                {profile?.is_verified && "‚úì"}
                            </div>
                        </div>
                        <div
                            class="w-12 h-12 rounded-2xl bg-gradient-to-br from-primary-900 to-primary-800 text-white flex items-center justify-center font-heading text-lg shadow-lg shadow-primary-900/20 cursor-pointer hover:scale-105 transition-transform overflow-hidden"
                        >
                            {
                                profile?.avatar_url ? (
                                    <img
                                        src={profile.avatar_url}
                                        alt="Profile"
                                        class="w-full h-full object-cover"
                                    />
                                ) : (
                                    <span>
                                        {profile?.full_name?.[0] || "U"}
                                    </span>
                                )
                            }
                        </div>
                    </div>
                </div>
            </header>

            <!-- Content Area -->
            <div
                class="flex-grow overflow-y-auto p-6 md:p-10 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] bg-fixed relative"
            >
                <slot />
            </div>
        </main>
    </body>
</html>

<script>
    import { createSupabaseBrowserClient } from "../lib/supabase";
    const supabase = createSupabaseBrowserClient();

    document
        .getElementById("logout-btn")
        ?.addEventListener("click", async () => {
            await supabase.auth.signOut();
            window.location.href = "/login";
        });
</script>

<style>
    /* Custom Scrollbar for Sidebar */
    .custom-scrollbar::-webkit-scrollbar {
        width: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 2px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.2);
    }
</style>
