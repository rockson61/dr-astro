---
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import { createSupabaseServerClient } from '../../lib/supabase';

export const prerender = false;

const supabase = createSupabaseServerClient(Astro);
const { data: { user } } = await supabase.auth.getUser();

if (!user) {
  return Astro.redirect('/login');
}

// Fetch user's articles
const { data: articles } = await supabase
  .from('articles')
  .select('id, title, slug, status, published_at, views_count')
  .eq('author_id', user.id)
  .order('created_at', { ascending: false });

const statusColors: Record<string, string> = {
  published: 'bg-green-100 text-green-700',
  draft: 'bg-yellow-100 text-yellow-700',
  pending: 'bg-blue-100 text-blue-700',
  rejected: 'bg-red-100 text-red-700',
};
---

<DashboardLayout title="My Articles">
    <div class="flex justify-between items-center mb-8">
        <div>
            <h2 class="text-2xl font-bold dark:text-white">My Articles</h2>
            <p class="text-gray-500">Manage your published and draft articles.</p>
        </div>
        <a href="/dashboard/articles/new" class="px-6 py-3 bg-tuio-pink text-white rounded-full font-bold hover:bg-tuio-navy transition-all">
            + New Article
        </a>
    </div>

    {articles && articles.length > 0 ? (
        <div class="bg-white dark:bg-neutral-800 rounded-[24px] overflow-hidden shadow-sm">
            <table class="w-full">
                <thead class="bg-gray-50 dark:bg-neutral-900">
                    <tr>
                        <th class="text-left px-6 py-4 text-sm font-bold text-gray-500 uppercase tracking-wider">Title</th>
                        <th class="text-left px-6 py-4 text-sm font-bold text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="text-left px-6 py-4 text-sm font-bold text-gray-500 uppercase tracking-wider">Views</th>
                        <th class="text-right px-6 py-4 text-sm font-bold text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100 dark:divide-neutral-700">
                    {articles.map((article: any) => (
                        <tr class="hover:bg-gray-50 dark:hover:bg-neutral-700/50 transition-colors">
                            <td class="px-6 py-4">
                                <a href={`/articles/${article.slug}`} class="font-medium text-tuio-navy dark:text-white hover:text-tuio-pink transition-colors">
                                    {article.title}
                                </a>
                            </td>
                            <td class="px-6 py-4">
                                <span class={`text-xs font-bold uppercase px-3 py-1 rounded-full ${statusColors[article.status] || 'bg-gray-100 text-gray-700'}`}>
                                    {article.status}
                                </span>
                            </td>
                            <td class="px-6 py-4 text-gray-500">{article.views_count || 0}</td>
                            <td class="px-6 py-4 text-right">
                                <a href={`/dashboard/articles/edit/${article.id}`} class="text-tuio-pink hover:underline text-sm font-medium">Edit</a>
                            </td>
                        </tr>
                    ))}
                </tbody>
            </table>
        </div>
    ) : (
        <div class="bg-white dark:bg-neutral-800 rounded-[24px] p-16 text-center shadow-sm">
            <div class="text-6xl mb-6">üìù</div>
            <h3 class="text-2xl font-bold text-tuio-navy dark:text-white mb-2">No articles yet</h3>
            <p class="text-gray-500 mb-6">Start sharing your expertise with the dental community.</p>
            <a href="/dashboard/articles/new" class="inline-block px-8 py-3 bg-tuio-pink text-white rounded-full font-bold hover:bg-tuio-navy transition-all">
                Write Your First Article
            </a>
        </div>
    )}
</DashboardLayout>
