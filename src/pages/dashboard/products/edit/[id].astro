---
import DashboardLayout from "../../../../layouts/DashboardLayout.astro";
import { createSupabaseServerClient } from "../../../../lib/supabase";

export const prerender = false;

const { id } = Astro.params;
const supabase = createSupabaseServerClient(Astro);

const {
    data: { user },
} = await supabase.auth.getUser();
if (!user) return Astro.redirect("/login");

// Fetch product
const { data: product, error } = await supabase
    .from("products")
    .select("*")
    .eq("id", id)
    .single();

if (error || !product) return Astro.redirect("/404");

// Verify ownership
if (product.seller_id !== user.id)
    return Astro.redirect("/dashboard/my-products");

const categories = [
    "Equipment",
    "Instruments",
    "Materials",
    "Software",
    "Services",
    "Other",
];
---

<DashboardLayout title="Edit Product">
    <div class="max-w-4xl mx-auto animate-fade-in">
        <div class="mb-10 flex items-center justify-between">
            <div>
                <h2 class="text-3xl font-heading uppercase text-primary-900">
                    Edit Product
                </h2>
                <p class="text-gray-500 mt-1">Update your product details.</p>
            </div>
            <a
                href="/dashboard/my-products"
                class="text-gray-400 font-bold hover:text-primary-600 transition-colors flex items-center gap-2 text-sm uppercase tracking-wide"
            >
                ‚Üê Back to My Products
            </a>
        </div>

        <form class="space-y-8" data-product-id={product.id}>
            <!-- Basic Info -->
            <div class="glass-card bg-white p-8">
                <div
                    class="flex items-center gap-4 mb-6 pb-4 border-b border-gray-100"
                >
                    <span class="text-2xl">üì¶</span>
                    <h3 class="font-heading text-xl uppercase text-primary-900">
                        Product Details
                    </h3>
                </div>

                <div class="space-y-6">
                    <div>
                        <label
                            class="block text-xs font-bold text-gray-400 uppercase tracking-widest pl-1 mb-2"
                            >Product Name</label
                        >
                        <input
                            type="text"
                            name="name"
                            value={product.name}
                            required
                            class="w-full px-5 py-4 rounded-2xl border border-gray-200 bg-gray-50/50 text-primary-900 font-bold text-lg focus:ring-4 focus:ring-primary-600/20 focus:border-primary-600 focus:outline-none transition-all placeholder:font-normal"
                        />
                    </div>

                    <div class="grid md:grid-cols-2 gap-8">
                        <div>
                            <label
                                class="block text-xs font-bold text-gray-400 uppercase tracking-widest pl-1 mb-2"
                                >Category</label
                            >
                            <div class="relative">
                                <select
                                    name="category"
                                    class="w-full px-5 py-4 rounded-2xl border border-gray-200 bg-gray-50/50 text-primary-900 font-medium focus:ring-4 focus:ring-primary-600/20 focus:border-primary-600 focus:outline-none appearance-none cursor-pointer"
                                >
                                    {
                                        categories.map((cat) => (
                                            <option
                                                value={cat}
                                                selected={
                                                    product.category === cat
                                                }
                                            >
                                                {cat}
                                            </option>
                                        ))
                                    }
                                </select>
                                <div
                                    class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-gray-500"
                                >
                                    ‚ñº
                                </div>
                            </div>
                        </div>
                        <div>
                            <label
                                class="block text-xs font-bold text-gray-400 uppercase tracking-widest pl-1 mb-2"
                                >Price ($)</label
                            >
                            <input
                                type="number"
                                name="price"
                                value={product.price}
                                min="0"
                                step="0.01"
                                required
                                class="w-full px-5 py-4 rounded-2xl border border-gray-200 bg-gray-50/50 text-primary-900 font-bold focus:ring-4 focus:ring-primary-600/20 focus:border-primary-600 focus:outline-none transition-all"
                            />
                        </div>
                    </div>

                    <div>
                        <label
                            class="block text-xs font-bold text-gray-400 uppercase tracking-widest pl-1 mb-2"
                            >Description</label
                        >
                        <textarea
                            name="description"
                            rows="5"
                            required
                            class="w-full px-5 py-4 rounded-2xl border border-gray-200 bg-gray-50/50 text-primary-900 font-medium focus:ring-4 focus:ring-primary-600/20 focus:border-primary-600 focus:outline-none resize-none"
                            >{product.description}</textarea
                        >
                    </div>

                    <div>
                        <label
                            class="block text-xs font-bold text-gray-400 uppercase tracking-widest pl-1 mb-2"
                            >Status</label
                        >
                        <div class="relative">
                            <select
                                name="status"
                                class="w-full px-5 py-4 rounded-2xl border border-gray-200 bg-gray-50/50 text-primary-900 font-medium focus:ring-4 focus:ring-primary-600/20 focus:border-primary-600 focus:outline-none appearance-none cursor-pointer"
                            >
                                <option
                                    value="active"
                                    selected={product.status === "active"}
                                    >Active</option
                                >
                                <option
                                    value="draft"
                                    selected={product.status === "draft"}
                                    >Draft</option
                                >
                                <option
                                    value="archived"
                                    selected={product.status === "archived"}
                                    >Archived</option
                                >
                            </select>
                            <div
                                class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-gray-500"
                            >
                                ‚ñº
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Image Upload -->
            <div class="glass-card bg-white p-8">
                <div
                    class="flex items-center gap-4 mb-6 pb-4 border-b border-gray-100"
                >
                    <span class="text-2xl">üì∏</span>
                    <h3 class="font-heading text-xl uppercase text-primary-900">
                        Product Image
                    </h3>
                </div>
                <div>
                    <label
                        class="block text-xs font-bold text-gray-400 uppercase tracking-widest pl-1 mb-2"
                        >Image URL</label
                    >
                    <input
                        type="url"
                        name="image_url"
                        value={product.images?.[0] || ""}
                        class="w-full px-5 py-4 rounded-2xl border border-gray-200 bg-gray-50/50 text-primary-900 font-medium focus:ring-4 focus:ring-primary-600/20 focus:border-primary-600 focus:outline-none transition-all"
                    />
                </div>
            </div>

            <!-- Actions -->
            <div
                class="fixed bottom-0 left-0 right-0 p-6 bg-white/80 backdrop-blur-md border-t border-gray-200 md:static md:bg-transparent md:border-none md:p-0 flex justify-end z-40"
            >
                <button
                    type="submit"
                    class="px-10 py-4 bg-primary-600 text-white rounded-full font-bold uppercase tracking-wide hover:bg-primary-900 transition-all shadow-lg hover:shadow-xl hover:-translate-y-1"
                >
                    Save Changes
                </button>
            </div>
        </form>
    </div>
</DashboardLayout>

<script>
    import { createSupabaseBrowserClient } from "../../../../lib/supabase";

    const supabase = createSupabaseBrowserClient();
    const form = document.querySelector("form");
    const submitBtn = form?.querySelector('button[type="submit"]');

    form?.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!submitBtn) return;

        const originalText = submitBtn.textContent;
        submitBtn.textContent = "Saving...";
        (submitBtn as HTMLButtonElement).disabled = true;

        const productId = form.getAttribute("data-product-id");
        const formData = new FormData(form);
        const name = formData.get("name") as string;
        const price = formData.get("price");
        const description = formData.get("description");
        const category = formData.get("category");
        const status = formData.get("status");
        const imageUrl = formData.get("image_url") as string;

        try {
            const images = imageUrl ? [imageUrl] : [];

            const { error } = await supabase
                .from("products")
                .update({
                    name,
                    price,
                    description,
                    category,
                    status,
                    images,
                    updated_at: new Date().toISOString(),
                })
                .eq("id", productId);

            if (error) throw error;

            alert("Product updated successfully");
            window.location.href = "/dashboard/my-products";
        } catch (err: any) {
            console.error(err);
            alert("Error updating product: " + err.message);
            submitBtn.textContent = originalText;
            (submitBtn as HTMLButtonElement).disabled = false;
        }
    });
</script>
