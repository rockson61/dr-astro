---
import DashboardLayout from "../../../layouts/DashboardLayout.astro";
import { createSupabaseServerClient } from "../../../lib/supabase";

export const prerender = false;

const supabase = createSupabaseServerClient(Astro);
const {
    data: { user },
} = await supabase.auth.getUser();

if (!user) {
    return Astro.redirect("/login");
}

const listingTypes = [
    { value: "clinic", label: "Dental Clinic" },
    { value: "lab", label: "Dental Laboratory" },
    { value: "supplier", label: "Equipment Supplier" },
    { value: "education", label: "Training Institute" },
    { value: "other", label: "Other" },
];
---

<DashboardLayout title="Add New Listing">
    <div class="max-w-5xl mx-auto animate-fade-in">
        <div class="flex items-center justify-between mb-10">
            <div>
                <h2 class="text-3xl font-tuio uppercase text-tuio-navy">
                    Add New Listing
                </h2>
                <p class="text-gray-500 mt-1">
                    List your business in the DentalReach directory.
                </p>
            </div>
            <a
                href="/dashboard/my-listings"
                class="text-gray-400 font-bold hover:text-tuio-red transition-colors flex items-center gap-2 text-sm uppercase tracking-wide"
            >
                ‚Üê Back to My Listings
            </a>
        </div>

        <form class="space-y-8">
            <!-- Business Name -->
            <div class="tuio-card">
                <div
                    class="flex items-center gap-4 mb-6 pb-4 border-b border-gray-100"
                >
                    <span class="text-2xl">üè¢</span>
                    <h3 class="font-tuio text-xl uppercase text-tuio-navy">
                        Business Details
                    </h3>
                </div>
                <div class="space-y-6">
                    <div>
                        <label
                            class="block text-xs font-bold text-gray-400 uppercase tracking-widest pl-1 mb-2"
                            >Business Name</label
                        >
                        <input
                            type="text"
                            name="business_name"
                            class="w-full px-5 py-4 rounded-2xl border border-gray-200 bg-gray-50/50 text-tuio-navy font-bold text-lg focus:ring-4 focus:ring-tuio-red/20 focus:border-tuio-red focus:outline-none transition-all placeholder:font-normal"
                            placeholder="e.g. Smile Dental Clinic"
                        />
                    </div>
                </div>
            </div>

            <!-- Type & City -->
            <div class="grid md:grid-cols-2 gap-8">
                <div class="tuio-card">
                    <label
                        class="block text-xs font-bold text-gray-400 uppercase tracking-widest pl-1 mb-2"
                        >Business Type</label
                    >
                    <div class="relative">
                        <select
                            name="type"
                            class="w-full px-5 py-4 rounded-2xl border border-gray-200 bg-gray-50/50 text-tuio-navy font-medium focus:ring-4 focus:ring-tuio-red/20 focus:border-tuio-red focus:outline-none appearance-none cursor-pointer hover:bg-white transition-colors"
                        >
                            {
                                listingTypes.map((type) => (
                                    <option value={type.value}>
                                        {type.label}
                                    </option>
                                ))
                            }
                        </select>
                        <div
                            class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-gray-500"
                        >
                            ‚ñº
                        </div>
                    </div>
                </div>
                <div class="tuio-card">
                    <label
                        class="block text-xs font-bold text-gray-400 uppercase tracking-widest pl-1 mb-2"
                        >City</label
                    >
                    <input
                        type="text"
                        name="city"
                        class="w-full px-5 py-4 rounded-2xl border border-gray-200 bg-gray-50/50 text-tuio-navy font-medium focus:ring-4 focus:ring-tuio-red/20 focus:border-tuio-red focus:outline-none transition-all"
                        placeholder="e.g. Mumbai"
                    />
                </div>
            </div>

            <!-- Address -->
            <div class="tuio-card">
                <label
                    class="block text-xs font-bold text-gray-400 uppercase tracking-widest pl-1 mb-2"
                    >Full Address</label
                >
                <textarea
                    name="address"
                    rows="2"
                    class="w-full px-5 py-4 rounded-2xl border border-gray-200 bg-gray-50/50 text-tuio-navy font-medium focus:ring-4 focus:ring-tuio-red/20 focus:border-tuio-red focus:outline-none resize-none"
                    placeholder="123 Main Street, Medical Complex, Building A"
                ></textarea>
            </div>

            <!-- Contact -->
            <div class="grid md:grid-cols-2 gap-8">
                <div class="tuio-card">
                    <label
                        class="block text-xs font-bold text-gray-400 uppercase tracking-widest pl-1 mb-2"
                        >Phone Number</label
                    >
                    <input
                        type="tel"
                        name="phone"
                        class="w-full px-5 py-4 rounded-2xl border border-gray-200 bg-gray-50/50 text-tuio-navy font-medium focus:ring-4 focus:ring-tuio-red/20 focus:border-tuio-red focus:outline-none transition-all"
                        placeholder="+91 98765 43210"
                    />
                </div>
                <div class="tuio-card">
                    <label
                        class="block text-xs font-bold text-gray-400 uppercase tracking-widest pl-1 mb-2"
                        >Website</label
                    >
                    <input
                        type="url"
                        name="website"
                        class="w-full px-5 py-4 rounded-2xl border border-gray-200 bg-gray-50/50 text-tuio-navy font-medium focus:ring-4 focus:ring-tuio-red/20 focus:border-tuio-red focus:outline-none transition-all"
                        placeholder="https://smiledental.com"
                    />
                </div>
            </div>

            <!-- Description -->
            <div class="tuio-card">
                <label
                    class="block text-xs font-bold text-gray-400 uppercase tracking-widest pl-1 mb-2"
                    >Description</label
                >
                <textarea
                    name="description"
                    rows="5"
                    class="w-full px-5 py-4 rounded-2xl border border-gray-200 bg-gray-50/50 text-tuio-navy font-medium focus:ring-4 focus:ring-tuio-red/20 focus:border-tuio-red focus:outline-none resize-none"
                    placeholder="Describe your services, specialties, and what makes your business unique..."
                ></textarea>
            </div>

            <!-- Services -->
            <div class="tuio-card">
                <label
                    class="block text-xs font-bold text-gray-400 uppercase tracking-widest pl-1 mb-4"
                    >Services Offered</label
                >
                <div class="flex flex-wrap gap-3">
                    {
                        [
                            "General Dentistry",
                            "Orthodontics",
                            "Implants",
                            "Cosmetic",
                            "Pediatric",
                            "Oral Surgery",
                            "Periodontics",
                            "Endodontics",
                            "Prosthodontics",
                        ].map((service) => (
                            <label class="cursor-pointer group">
                                <input
                                    type="checkbox"
                                    name="services"
                                    value={service
                                        .toLowerCase()
                                        .replace(" ", "-")}
                                    class="peer sr-only"
                                />
                                <span class="inline-block px-5 py-2 bg-gray-50 rounded-full text-sm font-bold text-gray-500 border border-transparent peer-checked:bg-tuio-red peer-checked:text-white peer-checked:shadow-md transition-all group-hover:bg-gray-100">
                                    {service}
                                </span>
                            </label>
                        ))
                    }
                </div>
            </div>

            <!-- Images -->
            <div class="tuio-card">
                <label
                    class="block text-xs font-bold text-gray-400 uppercase tracking-widest pl-1 mb-2"
                    >Business Photos</label
                >
                <div
                    class="border-2 border-dashed border-gray-200 rounded-3xl p-10 text-center hover:bg-gray-50 transition-colors group cursor-pointer relative overflow-hidden"
                >
                    <div class="relative z-10">
                        <div
                            class="w-20 h-20 bg-tuio-bg rounded-full flex items-center justify-center text-4xl mx-auto mb-4 group-hover:scale-110 transition-transform shadow-sm"
                        >
                            üì∏
                        </div>
                        <p class="text-tuio-navy font-medium mb-1">
                            Drag and drop photos of your clinic/business
                        </p>
                        <p class="text-xs text-gray-400 mb-6">
                            Max 5 images. Recommended: High quality, well lit.
                        </p>
                        <input
                            type="file"
                            name="images"
                            accept="image/*"
                            multiple
                            class="hidden"
                            id="images-upload"
                        />
                        <label
                            for="images-upload"
                            class="inline-block px-8 py-3 bg-white text-tuio-navy border border-gray-200 rounded-full font-bold uppercase tracking-wide text-xs cursor-pointer hover:bg-tuio-navy hover:text-white transition-all shadow-sm"
                        >
                            Choose Files
                        </label>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div
                class="fixed bottom-0 left-0 right-0 p-6 bg-white/80 backdrop-blur-md border-t border-gray-200 md:static md:bg-transparent md:border-none md:p-0 flex gap-4 justify-end z-40"
            >
                <button
                    type="button"
                    class="px-8 py-4 border-2 border-gray-200 text-gray-500 rounded-full font-bold uppercase tracking-wide hover:border-gray-400 hover:text-gray-700 transition-all bg-white"
                >
                    Save Draft
                </button>
                <button
                    type="submit"
                    class="px-10 py-4 bg-tuio-red text-white rounded-full font-bold uppercase tracking-wide hover:bg-tuio-navy transition-all shadow-lg hover:shadow-xl hover:-translate-y-1"
                >
                    Submit for Verification
                </button>
            </div>
        </form>
    </div>
</DashboardLayout>

<script>
    import { createSupabaseBrowserClient } from "../../../lib/supabase";

    const supabase = createSupabaseBrowserClient();
    const form = document.querySelector("form");
    const submitBtn = form?.querySelector('button[type="submit"]');

    function slugify(text: string) {
        return text
            .toString()
            .toLowerCase()
            .replace(/\s+/g, "-")
            .replace(/[^\w\-]+/g, "")
            .replace(/\-\-+/g, "-")
            .replace(/^-+/, "")
            .replace(/-+$/, "");
    }

    form?.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!submitBtn) return;

        const originalText = submitBtn.textContent;
        submitBtn.textContent = "Submitting...";
        (submitBtn as HTMLButtonElement).disabled = true;

        const formData = new FormData(form);
        const business_name = formData.get("business_name") as string;
        const type = formData.get("type");
        const city = formData.get("city");
        const address = formData.get("address");
        const phone = formData.get("phone");
        const website = formData.get("website");
        const description = formData.get("description");

        // Handle multiselect services if needed, currently just grabbing first checked
        // Ideally serialize all checked boxes for an array column

        if (!business_name || !city || !description) {
            alert("Please fill in required fields");
            submitBtn.textContent = originalText;
            (submitBtn as HTMLButtonElement).disabled = false;
            return;
        }

        try {
            const {
                data: { user },
            } = await supabase.auth.getUser();
            if (!user) throw new Error("Not authenticated");

            const slug = `${slugify(business_name)}-${Math.random().toString(36).substring(2, 7)}`;

            // Construct address JSON if schema requires, or simple text
            // Schema has address_json JSONB
            const addressJson = {
                full_address: address,
                city: city,
                country: "India", // Default or add field
            };

            const { error } = await supabase.from("listings").insert({
                business_name,
                slug,
                type,
                description,
                contact_phone: phone,
                website,
                address_json: addressJson,
                owner_id: user.id,
                is_verified: false, // Requires admin approval
                created_at: new Date().toISOString(),
            });

            if (error) throw error;

            window.location.href = "/dashboard/my-listings";
        } catch (err: any) {
            console.error(err);
            alert("Error creating listing: " + err.message);
            submitBtn.textContent = originalText;
            (submitBtn as HTMLButtonElement).disabled = false;
        }
    });
</script>
