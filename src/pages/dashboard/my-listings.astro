---
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import { createSupabaseServerClient } from '../../lib/supabase';

export const prerender = false;

const supabase = createSupabaseServerClient(Astro);
const { data: { user } } = await supabase.auth.getUser();

if (!user) {
  return Astro.redirect('/login');
}

// Fetch user's listings
const { data: listings } = await supabase
  .from('listings')
  .select('id, business_name, slug, is_verified, rating_avg, created_at')
  .eq('owner_id', user.id)
  .order('created_at', { ascending: false });
---

<DashboardLayout title="My Listings">
    <div class="flex justify-between items-center mb-8">
        <div>
            <h2 class="text-2xl font-bold dark:text-white">My Business Listings</h2>
            <p class="text-gray-500">Manage your directory listings.</p>
        </div>
        <a href="/dashboard/listings/new" class="px-6 py-3 bg-tuio-pink text-white rounded-full font-bold hover:bg-tuio-navy transition-all">
            + Add Listing
        </a>
    </div>

    {listings && listings.length > 0 ? (
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
            {listings.map((listing: any) => (
                <div class="bg-white dark:bg-neutral-800 rounded-[24px] p-6 shadow-sm hover:shadow-lg transition-all border border-transparent hover:border-tuio-pink">
                    <div class="flex items-start justify-between mb-4">
                        <div class="w-12 h-12 bg-tuio-bg rounded-xl flex items-center justify-center text-xl font-bold text-tuio-pink">
                            {listing.business_name.substring(0,2).toUpperCase()}
                        </div>
                        {listing.is_verified && (
                            <span class="text-xs font-bold uppercase px-3 py-1 rounded-full bg-green-100 text-green-700 flex items-center gap-1">
                                âœ“ Verified
                            </span>
                        )}
                    </div>
                    <h3 class="text-xl font-bold text-tuio-navy dark:text-white mb-2">{listing.business_name}</h3>
                    <div class="flex items-center gap-2 text-yellow-500 mb-4">
                        <span>â˜… {listing.rating_avg || 'N/A'}</span>
                    </div>
                    <div class="flex gap-2">
                        <a href={`/directory/${listing.slug}`} class="flex-1 text-center py-2 border border-gray-200 rounded-full text-gray-600 hover:border-tuio-pink hover:text-tuio-pink transition-all text-sm font-medium">
                            View
                        </a>
                        <a href={`/dashboard/listings/edit/${listing.id}`} class="flex-1 text-center py-2 bg-tuio-bg rounded-full text-tuio-navy hover:bg-tuio-pink hover:text-white transition-all text-sm font-medium">
                            Edit
                        </a>
                    </div>
                </div>
            ))}
        </div>
    ) : (
        <div class="bg-white dark:bg-neutral-800 rounded-[24px] p-16 text-center shadow-sm">
            <div class="text-6xl mb-6">ğŸ¢</div>
            <h3 class="text-2xl font-bold text-tuio-navy dark:text-white mb-2">No listings yet</h3>
            <p class="text-gray-500 mb-6">Add your clinic or lab to the DentalReach directory.</p>
            <a href="/dashboard/listings/new" class="inline-block px-8 py-3 bg-tuio-pink text-white rounded-full font-bold hover:bg-tuio-navy transition-all">
                Create Your First Listing
            </a>
        </div>
    )}
</DashboardLayout>
