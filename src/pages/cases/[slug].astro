---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { createSupabaseServerClient } from "../../lib/supabase";
import { User, Activity, FileText, CheckCircle } from "lucide-react";

export const prerender = false;

const { slug } = Astro.params;
const supabase = createSupabaseServerClient(Astro);

// Fetch case
const { data: caseStudy, error } = await supabase
    .from("clinical_cases")
    .select("*, author:profiles(full_name, avatar_url, job_title)")
    .eq("slug", slug)
    //.eq("status", "published") // Uncomment in prod
    .single();

if (error || !caseStudy) {
    return Astro.redirect("/404");
}

const steps = [
    {
        title: "Chief Complaint",
        icon: User,
        content: caseStudy.chief_complaint,
    },
    { title: "Diagnosis", icon: Activity, content: caseStudy.diagnosis },
    {
        title: "Treatment Plan",
        icon: FileText,
        content: caseStudy.treatment_plan,
    },
    {
        title: "Execution",
        icon: CheckCircle,
        content: caseStudy.procedure_details,
    },
];
---

<BaseLayout title={`${caseStudy.title} | Clinical Case`}>
    {/* Header */}
    <div class="bg-tuio-navy text-white pt-32 pb-20 relative overflow-hidden">
        <div
            class="absolute inset-0 bg-[url('/images/pattern.png')] opacity-10"
        >
        </div>
        <div class="container mx-auto px-4 relative z-10">
            <span
                class="bg-tuio-red text-white px-4 py-1 rounded-full text-xs font-bold uppercase tracking-widest mb-4 inline-block"
            >
                Clinical Case Study
            </span>
            <h1
                class="text-3xl md:text-5xl font-tuio uppercase mb-6 leading-tight max-w-4xl"
            >
                {caseStudy.title}
            </h1>

            <div
                class="flex items-center gap-6 mt-8 p-6 bg-white/10 backdrop-blur-md rounded-2xl border border-white/10 max-w-2xl"
            >
                <img
                    src={caseStudy.author?.avatar_url ||
                        `https://ui-avatars.com/api/?name=${caseStudy.author?.full_name}&background=random`}
                    class="w-16 h-16 rounded-full border-2 border-tuio-red"
                />
                <div>
                    <div
                        class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-1"
                    >
                        Presented By
                    </div>
                    <div class="font-tuio text-xl">
                        {caseStudy.author?.full_name}
                    </div>
                    <div class="text-sm text-gray-300">
                        {caseStudy.author?.job_title || "Dental Professional"}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="bg-gray-50 min-h-screen py-12">
        <div class="container mx-auto px-4">
            <div class="grid lg:grid-cols-12 gap-12">
                {/* Available Tools / TOC (Left) */}
                <div class="hidden lg:block lg:col-span-3">
                    <div class="sticky top-32 space-y-4">
                        <div
                            class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100"
                        >
                            <h3
                                className="font-bold text-gray-400 uppercase text-xs tracking-widest mb-4"
                            >
                                Case Overview
                            </h3>
                            {/* Patient Badge */}
                            <div class="space-y-3 text-sm">
                                <div
                                    class="flex justify-between border-b border-gray-50 pb-2"
                                >
                                    <span class="text-gray-500">Age</span>
                                    <span class="font-bold text-tuio-navy"
                                        >{caseStudy.patient_age}</span
                                    >
                                </div>
                                <div
                                    class="flex justify-between border-b border-gray-50 pb-2"
                                >
                                    <span class="text-gray-500">Gender</span>
                                    <span class="font-bold text-tuio-navy"
                                        >{caseStudy.gender}</span
                                    >
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                {/* Main Content (Center) */}
                <div class="lg:col-span-9 space-y-12">
                    {/* Pre-Op Images */}
                    {
                        caseStudy.pre_op_images?.length > 0 && (
                            <section>
                                <h2 class="text-2xl font-tuio uppercase text-tuio-navy mb-6 flex items-center gap-3">
                                    <span class="w-8 h-8 rounded-full bg-tuio-red text-white flex items-center justify-center text-sm font-bold">
                                        1
                                    </span>
                                    Pre-Operative Assessment
                                </h2>
                                <div class="grid md:grid-cols-2 gap-4">
                                    {caseStudy.pre_op_images.map(
                                        (img: string) => (
                                            <img
                                                src={img}
                                                class="rounded-2xl shadow-md w-full h-64 object-cover hover:scale-[1.02] transition-transform"
                                            />
                                        ),
                                    )}
                                </div>
                            </section>
                        )
                    }

                    {/* Steps */}
                    <div class="space-y-8">
                        {
                            steps.map(
                                (step, index) =>
                                    step.content && (
                                        <div class="bg-white p-8 rounded-[32px] shadow-sm border border-gray-100 relative overflow-hidden group hover:border-tuio-red/30 transition-colors">
                                            <div class="absolute top-0 right-0 p-8 opacity-5 group-hover:opacity-10 transition-opacity">
                                                {/* Icon placeholder if needed */}
                                            </div>
                                            <h3 class="font-tuio text-xl uppercase text-tuio-navy mb-4 flex items-center gap-3">
                                                <step.icon className="w-6 h-6 text-tuio-red" />
                                                {step.title}
                                            </h3>
                                            <div class="prose max-w-none text-gray-600 leading-relaxed whitespace-pre-line">
                                                {step.content}
                                            </div>
                                        </div>
                                    ),
                            )
                        }
                    </div>

                    {/* Post-Op Images */}
                    {
                        caseStudy.post_op_images?.length > 0 && (
                            <section>
                                <h2 class="text-2xl font-tuio uppercase text-tuio-navy mb-6 flex items-center gap-3">
                                    <span class="w-8 h-8 rounded-full bg-green-500 text-white flex items-center justify-center text-sm font-bold">
                                        âœ“
                                    </span>
                                    Final Result
                                </h2>
                                <div class="grid md:grid-cols-2 gap-4">
                                    {caseStudy.post_op_images.map(
                                        (img: string) => (
                                            <img
                                                src={img}
                                                class="rounded-2xl shadow-md w-full h-64 object-cover hover:scale-[1.02] transition-transform"
                                            />
                                        ),
                                    )}
                                </div>
                            </section>
                        )
                    }

                    {/* Discussion / Conclusion */}
                    {
                        caseStudy.conclusion && (
                            <div class="bg-tuio-navy text-white p-8 rounded-[32px] shadow-lg">
                                <h3 class="font-tuio text-xl uppercase mb-4">
                                    Conclusion & Discussion
                                </h3>
                                <p class="leading-relaxed opacity-90">
                                    {caseStudy.conclusion}
                                </p>
                            </div>
                        )
                    }
                </div>
            </div>
        </div>
    </div>
</BaseLayout>
